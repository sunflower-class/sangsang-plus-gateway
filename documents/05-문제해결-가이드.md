# 문제 해결 가이드

## 일반적인 문제들

### 1. JWT 토큰 검증 실패

#### 증상
- HTTP 401 Unauthorized 응답
- "INVALID_TOKEN" 또는 "TOKEN_EXPIRED" 메시지
- 다운스트림 서비스에서 403 Forbidden 에러

#### 원인 분석
```bash
# 게이트웨이 로그 확인
kubectl logs deployment/sangsang-plus-gateway | grep -i "jwt\|token\|unauthorized"

# JWT 토큰 디버깅
curl https://oauth.buildingbite.com/api/auth/debug-token \
  -H "Authorization: Bearer <your-jwt-token>"
```

#### 해결 방법
1. **토큰 만료 확인**
   ```bash
   # JWT 토큰 만료 시간 확인 (jwt.io 사이트 이용)
   echo "eyJhbGciOiJSUzI1NiIs..." | base64 -d
   ```

2. **Keycloak 공개키 확인**
   ```bash
   # 공개키 파일 존재 확인
   kubectl exec deployment/sangsang-plus-gateway -- cat /etc/secrets/jwt-public-key/public.pem
   ```

3. **Issuer URL 확인**
   ```bash
   # 환경 변수 확인
   kubectl get deployment sangsang-plus-gateway -o yaml | grep -i keycloak
   ```

### 2. X-User-Id 헤더 누락

#### 증상
- 다운스트림 서비스에서 403 Forbidden
- "X-User-Id 헤더가 필요합니다" 에러 메시지
- 사용자 정보 조회/수정 실패

#### 원인 분석
```bash
# JWT 클레임 전체 분석
kubectl logs deployment/sangsang-plus-gateway | grep -A 20 "All JWT Claims"

# UserService 조회 로그 확인
kubectl logs deployment/sangsang-plus-gateway | grep "UserService.*사용자 ID"
```

#### 해결 방법
1. **JWT에 userId 클레임 추가** (Keycloak 설정)
   ```bash
   # Keycloak 매퍼 설정 호출
   curl -X POST https://oauth.buildingbite.com/api/auth/setup-mappers
   ```

2. **UserService 연결 확인**
   ```bash
   # UserService 헬스체크
   kubectl get svc -n user-service
   kubectl logs deployment/user-service | tail -10
   ```

3. **수동 헤더 추가 확인** (내부 엔드포인트)
   ```bash
   # 헤더 추가 로그 확인
   kubectl logs deployment/sangsang-plus-gateway | grep "X-User-Id 헤더 추가함"
   ```

### 3. Refresh Token 문제

#### 증상
- 토큰 갱신 시 refresh_token이 null로 반환
- "REFRESH_TOKEN_ERROR" 메시지
- 지속적인 재로그인 요구

#### 원인 분석
```bash
# 토큰 갱신 로그 확인
kubectl logs deployment/sangsang-plus-gateway | grep -i "refresh"

# Keycloak 연결 상태 확인
kubectl exec deployment/sangsang-plus-gateway -- curl -s http://keycloak:8080/health
```

#### 해결 방법
1. **Keycloak Token 설정 확인**
   - Refresh Token Max Reuse: 활성화 (값: 0 또는 1)
   - Access Token Lifespan: 5분
   - Refresh Token Lifespan: 30일

2. **백엔드 폴백 로직 확인**
   ```bash
   # 폴백 로직 작동 로그
   kubectl logs deployment/sangsang-plus-gateway | grep "기존 토큰을 재사용"
   ```

3. **프론트엔드 null 처리**
   ```javascript
   // Refresh token 응답 처리
   if (response.data.refreshToken) {
     localStorage.setItem('refreshToken', response.data.refreshToken);
   }
   // refreshToken이 null이어도 기존 것 유지
   ```

### 4. 로그아웃 500 에러

#### 증상
- 로그아웃 시 HTTP 500 Internal Server Error
- 토큰 만료 상태에서 로그아웃 실패

#### 원인 분석
```bash
# 로그아웃 관련 로그
kubectl logs deployment/sangsang-plus-gateway | grep -i "logout"

# Spring Security 인증 관련 로그
kubectl logs deployment/sangsang-plus-gateway | grep "@PreAuthorize"
```

#### 해결 방법
1. **@PreAuthorize 제거 확인** (이미 수정됨)
   ```java
   @PostMapping("/auth/logout")
   // @PreAuthorize 주석 처리됨
   public ResponseEntity<Map<String, Object>> logout(...)
   ```

2. **graceful 로그아웃 처리**
   - refresh_token 없어도 성공 처리
   - Keycloak 로그아웃 실패해도 클라이언트 로그아웃 성공

### 5. CORS 에러

#### 증상
- 브라우저 콘솔에 CORS policy 에러
- "Access-Control-Allow-Origin" 헤더 누락
- Preflight 요청 실패

#### 원인 분석
```bash
# CORS preflight 테스트
curl -X OPTIONS "https://oauth.buildingbite.com/api/management/chat/query" \
  -H "Origin: https://buildingbite.com" \
  -H "Access-Control-Request-Method: POST"
```

#### 해결 방법
1. **Istio VirtualService CORS 정책 확인**
   ```bash
   kubectl get virtualservice -o yaml | grep -A 10 corsPolicy
   ```

2. **Spring Security CORS 설정 확인**
   ```java
   // SecurityConfig.java의 CORS 설정
   .cors(cors -> cors.configurationSource(corsConfigurationSource()))
   ```

### 6. 서비스 간 통신 문제

#### 증상
- "Connection refused" 에러
- 다운스트림 서비스 응답 없음
- Service discovery 실패

#### 원인 분석
```bash
# 서비스 상태 확인
kubectl get svc -A
kubectl get endpoints -A

# DNS 해결 테스트
kubectl exec deployment/sangsang-plus-gateway -- nslookup user-service.user-service.svc.cluster.local
```

#### 해결 방법
1. **서비스 URL 확인**
   ```bash
   # 환경 변수 검증
   kubectl get deployment sangsang-plus-gateway -o yaml | grep -A 5 -B 5 SERVICE_URL
   ```

2. **Kubernetes 네트워크 정책 확인**
   ```bash
   kubectl get networkpolicy -A
   ```

3. **서비스 포트 확인**
   ```bash
   kubectl get svc user-service -n user-service
   kubectl get svc product-service -n product-service
   ```

## 로그 분석 가이드

### 주요 로그 패턴

#### 1. JWT 처리 로그
```bash
# 성공적인 JWT 처리
kubectl logs deployment/sangsang-plus-gateway | grep "JWT Token Analysis"

# JWT 검증 실패
kubectl logs deployment/sangsang-plus-gateway | grep "JWT 검증 실패"
```

#### 2. 사용자 ID 조회 로그
```bash
# UserService 조회 성공
kubectl logs deployment/sangsang-plus-gateway | grep "UserService.*조회 성공"

# UserService 조회 실패
kubectl logs deployment/sangsang-plus-gateway | grep "UserService.*조회 실패"
```

#### 3. 헤더 전파 로그
```bash
# 자동 헤더 추가 (외부 라우트)
kubectl logs deployment/sangsang-plus-gateway | grep "Headers being sent to downstream"

# 수동 헤더 추가 (내부 엔드포인트)
kubectl logs deployment/sangsang-plus-gateway | grep "X-User-Id 헤더 추가함"
```

## 개발 환경 디버깅

### 로컬 테스트 명령어
```bash
# 헬스체크
curl https://oauth.buildingbite.com/api/health

# 로그인 테스트
curl -X POST https://oauth.buildingbite.com/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email": "test@example.com", "password": "test123"}'

# 인증된 요청 테스트
curl https://oauth.buildingbite.com/api/users/me \
  -H "Authorization: Bearer <jwt-token>"

# 토큰 갱신 테스트
curl -X POST https://oauth.buildingbite.com/api/auth/refresh \
  -H "Content-Type: application/json" \
  -d '{"refresh_token": "<refresh-token>"}'
```

### Kubernetes 디버깅
```bash
# Pod 상태 확인
kubectl get pods | grep sangsang-plus-gateway

# 실시간 로그 모니터링
kubectl logs -f deployment/sangsang-plus-gateway

# Pod 내부 접속
kubectl exec -it deployment/sangsang-plus-gateway -- /bin/bash

# 환경 변수 확인
kubectl exec deployment/sangsang-plus-gateway -- env | grep -i keycloak
```

## 성능 모니터링

### 메트릭 확인
```bash
# CPU/Memory 사용률
kubectl top pods | grep sangsang-plus-gateway

# 요청 응답 시간 측정
curl -w "@curl-format.txt" -s -o /dev/null https://oauth.buildingbite.com/api/health

# 동시 연결 수 테스트
ab -n 1000 -c 10 https://oauth.buildingbite.com/api/health
```

### 로그 레벨 조정
```yaml
# application.yml
logging:
  level:
    com.example.gateway: DEBUG
    org.springframework.security: DEBUG
    org.springframework.web: DEBUG
```

## 알려진 이슈와 해결책

### 1. ✅ X-User-Id 헤더 누락 (해결됨)
**문제**: JWT에 userId 클레임 없어서 다운스트림 403 에러
**해결**: JWT 필터 강화 + UserService 폴백 조회 + 수동 헤더 추가

### 2. ✅ Refresh Token null 반환 (해결됨)
**문제**: Keycloak이 새 refresh_token 발급 안함
**해결**: null일 때 기존 토큰 재사용 로직 추가

### 3. ✅ 로그아웃 500 에러 (해결됨)
**문제**: 토큰 만료 상태에서 @PreAuthorize로 인한 인증 실패
**해결**: @PreAuthorize 제거 + graceful 로그아웃 처리

### 4. ✅ CORS 정책 문제 (해결됨)
**문제**: Istio Authorization Policy가 preflight 요청 차단
**해결**: Authorization Policy 제거 + mTLS PERMISSIVE + VirtualService CORS 설정

## 긴급 복구 절차

### 서비스 재시작
```bash
# 게이트웨이 재시작
kubectl rollout restart deployment/sangsang-plus-gateway

# 상태 확인
kubectl rollout status deployment/sangsang-plus-gateway

# 로그 확인
kubectl logs deployment/sangsang-plus-gateway --tail=50
```

### 설정 롤백
```bash
# 이전 버전으로 롤백
kubectl rollout undo deployment/sangsang-plus-gateway

# 롤백 이력 확인
kubectl rollout history deployment/sangsang-plus-gateway
```

### 헬스체크 자동화
```bash
#!/bin/bash
# health-check.sh
while true; do
  status=$(curl -s -o /dev/null -w "%{http_code}" https://oauth.buildingbite.com/api/health)
  if [ "$status" != "200" ]; then
    echo "$(date): Health check failed with status $status"
    # 알림 또는 자동 복구 로직
  fi
  sleep 30
done
```