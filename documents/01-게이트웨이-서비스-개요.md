# 게이트웨이 서비스 개요

## 서비스 설명
Keycloak OAuth2/OIDC 인증과 Google 소셜 로그인을 지원하는 Spring Cloud Gateway API 게이트웨이입니다. 중앙화된 JWT 검증을 구현하고 마이크로서비스(User Service, Product Service)로 요청을 라우팅합니다.

## 기술 스택
- **Spring Boot 2.7.14** with Spring Cloud Gateway (Reactive)
- **Keycloak 22.0.5** OAuth2/OIDC 인증
- **JWT (com.auth0:java-jwt:4.4.0)** 토큰 검증
- **Spring Security** OAuth2 Client 지원
- **Docker** 멀티스테이지 빌드
- **Kubernetes** 배포 및 시크릿 관리

## 서비스 아키텍처

### 핵심 컴포넌트
1. **게이트웨이 라우트** (application.yml 설정)
2. **JWT 게이트웨이 필터** (JwtAuthGatewayFilterFactory)
3. **인증 컨트롤러** (KeycloakAuthController, UserController)
4. **서비스 통합** (KeycloakService, UserService)

### 라우트 설정
```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: user-service
          uri: http://user-service.user-service.svc.cluster.local
          predicates:
            - Path=/api/users/**
          filters:
            - name: JwtAuth
        
        - id: product-service
          uri: http://product-service.product-service.svc.cluster.local:8082
          predicates:
            - Path=/api/products/**
          filters:
            - name: JwtAuth
```

## 환경 설정

### 필수 환경 변수
```bash
# 서비스 URL
USER_SERVICE_URL=http://user-service.user-service.svc.cluster.local
PRODUCT_SERVICE_URL=http://product-service.product-service.svc.cluster.local:8082

# Keycloak 설정
KEYCLOAK_AUTH_SERVER_URL=http://keycloak:8080
KEYCLOAK_REALM=sangsang-plus
KEYCLOAK_CLIENT_ID=gateway-client
KEYCLOAK_CLIENT_SECRET=<Keycloak 클라이언트 자격증명>
KEYCLOAK_ISSUER_URI=http://keycloak:8080/realms/sangsang-plus

# Google OAuth (소셜 로그인용)
GOOGLE_CLIENT_ID=<Google Console에서 발급>
GOOGLE_CLIENT_SECRET=<Google Console에서 발급>
```

### Kubernetes 시크릿
```bash
# 게이트웨이 시크릿
kubectl create secret generic gateway-secrets \
  --from-literal=keycloak-client-secret='your-keycloak-client-secret'

# JWT 토큰 검증용 공개키
kubectl create secret generic jwt-public-key --from-file=public.pem=public.pem
```

## 요청 처리 플로우

### 외부 라우트 플로우
```
클라이언트 → 게이트웨이 → JWT 필터 → 다운스트림 서비스

1. 클라이언트가 JWT 토큰과 함께 요청 전송
2. JwtAuthGatewayFilterFactory가 토큰 검증
3. 다운스트림 요청에 헤더 추가:
   - X-User-Id: UserService 조회로 얻은 사용자 ID
   - X-User-Email: JWT에서 추출한 이메일
   - X-User-Role: JWT에서 추출한 역할
   - X-User-Provider: 로그인 제공자 (LOCAL/GOOGLE)
   - X-User-LoginCount: JWT의 로그인 횟수
   - X-User-LastLoginAt: 마지막 로그인 시간
4. 다운스트림 서비스로 요청 전달
```

### 내부 라우트 플로우
```
클라이언트 → 게이트웨이 컨트롤러 → 수동 JWT 처리 → UserService → 다운스트림

1. 내부 컨트롤러(KeycloakAuthController/UserController)에서 요청 처리
2. 컨트롤러에서 직접 JWT 토큰 파싱
3. 수동 헤더 파라미터로 UserService 메서드 호출
4. RestTemplate을 통해 수동으로 헤더 추가
```

## 주요 기능

### 인증 방식
- **로컬 인증**: Keycloak을 통한 사용자명/비밀번호
- **Google 소셜 로그인**: 팝업 기반 OAuth2 플로우
- **JWT 토큰 검증**: Keycloak 공개키 대비 RSA 서명 검증

### 토큰 관리
- **Access Token**: 단기간 유효 (5분)
- **Refresh Token**: 장기간 유효 (30일), 로테이션 지원
- **토큰 갱신**: 폴백 로직을 포함한 자동 처리

### 보안 기능
- **CORS 설정**: buildingbite.com 도메인 크로스 오리진 지원
- **JWT 검증**: RSA-256 서명 검증
- **헤더 주입**: 다운스트림 서비스로 사용자 컨텍스트 전파
- **토큰 로테이션**: 재사용 탐지를 통한 Refresh Token 보안

## 배포 환경
- **플랫폼**: Kubernetes (Gitpod 환경)
- **도메인**: https://oauth.buildingbite.com
- **서비스 메시**: Istio with mTLS PERMISSIVE 모드
- **로드 밸런서**: Cloudflare + Istio Ingress Gateway
- **스케일링**: Horizontal Pod Autoscaler (HPA) 활성화